#!/usr/bin/env bash

# =================
# nnn file manager
# =================

# NNN_BMS: Bookmarks for quick navigation
export NNN_BMS="n:$HOME/project/github/tapppi/nix-config/flakes/nvim;m:$HOME/macos-setup;p:$HOME/project;g:$HOME/project/github/tapppi"

# NNN_COLORS: Context colors using Catppuccin-inspired scheme
# Using xterm 256 colors: Catppuccin Mocha palette
export NNN_COLORS='#89b4fa89dceb94e2d8f5c2e7'

# NNN_FCOLORS: File-specific colors using Catppuccin Mocha palette
# Order: block, char, dir, exec, regular, hard link, symlink, missing, orphan, fifo, socket, unknown
export NNN_FCOLORS='89dceb94e2d8cdd6f4a6e3a100b4befab387cdd6f4f38ba8eba0acf5c2e7'

# NNN_TRASH: Use macOS native trash command
export NNN_TRASH='trash'

# NNN_ORDER: Directory-specific sorting
# Downloads and Documents sorted by time
export NNN_ORDER="t:$HOME/Downloads;t:$HOME/Documents"

# cd shell to nnn dir on quit
# See: https://github.com/jarun/nnn/wiki/Basic-use-cases#configure-cd-on-quit
n() {
	# Block nesting of nnn in subshells
	[ "${NNNLVL:-0}" -eq 0 ] || {
		echo "nnn is already running"
		return
	}

	# The behaviour is set to cd on quit (nnn checks if NNN_TMPFILE is set)
	# If NNN_TMPFILE is set to a custom path, it must be exported for nnn to
	# see. To cd on quit only on ^G, remove the "export" and make sure not to
	# use a custom path, i.e. set NNN_TMPFILE *exactly* as follows:
	#      NNN_TMPFILE="${XDG_CONFIG_HOME:-$HOME/.config}/nnn/.lastd"
	export NNN_TMPFILE="${XDG_CONFIG_HOME:-$HOME/.config}/nnn/.lastd"

	# Unmask ^Q (, ^V etc.) (if required, see `stty -a`) to Quit nnn
	# stty start undef
	# stty stop undef
	# stty lwrap undef
	# stty lnext undef

	# The command builtin allows one to alias nnn to n, if desired, without
	# making an infinitely recursive alias
	command nnn "$@"

	[ ! -f "$NNN_TMPFILE" ] || {
		. "$NNN_TMPFILE"
		rm -f -- "$NNN_TMPFILE" >/dev/null
	}
}

# cd nnn to subshells pwd on quit
nnn_cd() {
	if ! [ -z "$NNN_PIPE" ]; then
		printf "%s\0" "0c${PWD}" ! >"${NNN_PIPE}" &
	fi
}

trap nnn_cd EXIT
