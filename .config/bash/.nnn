#!/usr/bin/env bash

# =================
# nnn file manager
# =================

# NNN_BMS: Bookmarks for quick navigation
export NNN_BMS="n:$HOME/project/github/tapppi/nix-config/flakes/nvim;m:$HOME/macos-setup;p:$HOME/project;g:$HOME/project/github/tapppi"

# # Export Context Colors
# NNN_COLORS: Context colors (xterm 256 colors followed by 8-color fallback)
# This is for if we have cattpuccin theme in shell
BLK="03" CHR="03" DIR="04" EXE="02" REG="07" HARDLINK="05" SYMLINK="05" MISSING="08" ORPHAN="01" FIFO="06" SOCK="03" UNKNOWN="01"
export NNN_COLORS="#9997E5D3;4231"
# This is for without catppuccin theme, but still use those colors
#BLK="E5" CHR="E5" DIR="99" EXE="97" REG="07" HARDLINK="E1" SYMLINK="E1" MISSING="08" ORPHAN="D3" FIFO="9F" SOCK="E5" UNKNOWN="D3"
#export NNN_COLORS="#04020301;4231"

# NNN_FCOLORS: File-specific colors
export NNN_FCOLORS="$BLK$CHR$DIR$EXE$REG$HARDLINK$SYMLINK$MISSING$ORPHAN$FIFO$SOCK$UNKNOWN"

# NNN_TRASH: Use macOS native trash command
export NNN_TRASH='trash'

# NNN_ORDER: Directory-specific sorting
# Downloads and Documents sorted by time
export NNN_ORDER="t:$HOME/Downloads;t:$HOME/Documents"

# NNN_FIFO: Enable FIFO for live previews
export NNN_FIFO=/tmp/nnn.fifo

# NNN_ICONLOOKUP: Enable icons in directory previews
export NNN_ICONLOOKUP=1

# NNN_PLUG: Configure plugins
# f:finder - macOS Finder integration
# o:fzopen - fuzzy file opener with fzf
# p:preview-tui - requires tmux session (toggle preview)
# d:diffs - file diff tool
# n:nmount - mount/unmount tool
# v:imgview - image viewer
# q:qfind - quick find first match and open in nuke
# s:qfd - quick find files using fd (load to selection)
# g:qrg - quick grep using rg (load to selection)
# c:!cd - change directory inline command
export NNN_PLUG='f:finder;o:fzopen;p:preview-tui;d:diffs;n:nmount;v:imgview;q:qfind;s:qfd;g:qrg;c:!read -r to && [ -n "$to" ] && printf "0c%s" "${to}" > "$NNN_PIPE"*'

# cd shell to nnn dir on quit
# See: https://github.com/jarun/nnn/wiki/Basic-use-cases#configure-cd-on-quit
n() {
	# Block nesting of nnn in subshells
	[ "${NNNLVL:-0}" -eq 0 ] || {
		echo "nnn is already running"
		return
	}

	# The behaviour is set to cd on quit (nnn checks if NNN_TMPFILE is set)
	# If NNN_TMPFILE is set to a custom path, it must be exported for nnn to
	# see. To cd on quit only on ^G, remove the "export" and make sure not to
	# use a custom path, i.e. set NNN_TMPFILE *exactly* as follows:
	#      NNN_TMPFILE="${XDG_CONFIG_HOME:-$HOME/.config}/nnn/.lastd"
	export NNN_TMPFILE="${XDG_CONFIG_HOME:-$HOME/.config}/nnn/.lastd"

	# Unmask ^Q (, ^V etc.) (if required, see `stty -a`) to Quit nnn
	# stty start undef
	# stty stop undef
	# stty lwrap undef
	# stty lnext undef

	# The command builtin allows one to alias nnn to n, if desired, without
	# making an infinitely recursive alias
	command nnn "$@"

	[ ! -f "$NNN_TMPFILE" ] || {
		. "$NNN_TMPFILE"
		rm -f -- "$NNN_TMPFILE" >/dev/null
	}
}

# cd nnn to subshells pwd on quit
nnn_cd() {
	if ! [ -z "$NNN_PIPE" ]; then
		printf "%s\0" "0c${PWD}" ! >"${NNN_PIPE}" &
	fi
}

trap nnn_cd EXIT
